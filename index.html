<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>CoCo壱クイズ</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="CoCo壱クイズ">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/icon-180.png">

<style>
  :root { --c1:#2563eb; --bg:#f5f7fb; }
  html,body{height:100%;margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
  .container{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:20px}
  h1{margin:0 0 8px}
  .muted{color:#667085}
  button{appearance:none;border:0;border-radius:12px;background:var(--c1);color:#fff;font-weight:700;padding:14px 16px}
  button.secondary{background:#eef2ff;color:#1f2a5a}
  .opt{display:block;width:100%;text-align:left;margin:10px 0;padding:14px 16px;border-radius:12px;background:#f2f4f7;border:1px solid transparent;font-weight:600}
  .opt.correct{background:#e6f9ec;border-color:#86efac}
  .opt.incorrect{background:#fdecec;border-color:#fca5a5}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row>*{flex:1}
  .center{display:flex;align-items:center;justify-content:center}
  input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #d0d5dd;font-size:16px}
  .topspace{height:8px}
  .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin:8px 0 16px}
  .bar{height:100%;background:var(--c1);width:0%}
  .chip{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#1f2a5a;font-size:12px;margin-bottom:8px}
  .splash{height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#e0f2fe,#d1fae5)}
  .fade{animation:fade .4s ease}
  @keyframes fade {from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none}}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash" class="splash">
  <div class="center" style="flex-direction:column;gap:16px">
    <div style="font-size:96px">🍛</div>
    <h1 style="margin:0">CoCo壱クイズ</h1>
    <div class="muted">教育用ミニアプリ（オフライン可）</div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="container">
    <!-- Start -->
    <div id="start" class="card fade">
      <h1>CoCo壱クイズ</h1>
      <div class="muted">出題設定を選んで「開始」をタップ</div>
      <div class="topspace"></div>

      <div class="row">
        <div class="card" style="flex:1">
          <div class="muted">カテゴリ</div>
          <select id="category" style="width:100%;padding:10px;border-radius:10px;border:1px solid #d0d5dd;font-size:16px"></select>
          <div style="height:12px"></div>
          <label style="display:flex;align-items:center;gap:8px">
            <input id="shuffle" type="checkbox" checked> 選択肢をシャッフル
          </label>
        </div>
        <div class="card" style="flex:1">
          <div class="muted">出題数</div>
          <input id="qcount" type="range" min="3" max="20" step="1" value="5" style="width:100%">
          <div><strong id="qcountLabel">5</strong> 問</div>
        </div>
      </div>

      <div style="height:12px"></div>
      <button id="startBtn" style="width:100%">開始</button>
    </div>

    <!-- Quiz -->
    <div id="quiz" class="card fade" style="display:none">
      <div class="chip" id="catChip"></div>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <h2 id="prompt" style="margin-top:0"></h2>

      <div id="choiceBox"></div>

      <div id="inputBox" style="display:none">
        <input id="answerInput" type="text" placeholder="答えを入力">
        <div style="height:10px"></div>
        <button id="answerBtn">答える</button>
      </div>

      <div id="result" class="fade" style="display:none;margin-top:8px;font-weight:700"></div>

      <div style="display:flex;gap:8px;margin-top:16px">
        <button id="nextBtn" class="secondary" style="flex:1">次へ</button>
      </div>
    </div>

    <!-- Result -->
    <div id="finish" class="card fade" style="display:none;text-align:center">
      <h1>結果</h1>
      <p id="score" style="font-size:20px"></p>
      <div style="height:8px"></div>
      <button id="againBtn">もう一度</button>
    </div>
  </div>
</div>

<script>
// ====== 問題 ======
const QUESTIONS = [
  { prompt:"キャンペーンの正式名称はどれ？",
    choices:["ココスマイル企画","ココリターン企画 ～CoCo試し～","ココトッピングフェスタ","ココ再来チャレンジ"],
    answer:"ココリターン企画 ～CoCo試し～", category:"キャンペーン" },
  { prompt:"トッピング券の「使用可能期間」はいつからいつまで？",
    choices:["9/1 ～ 10/31","納品後 ～ 10/31","10/1 ～ 11/30","10/1 ～ 12/31"],
    answer:"10/1 ～ 11/30", category:"キャンペーン" },
  { prompt:"配布対象はどれ？",
    choices:["店内・テイクアウト・宅配すべて","店内・テイクアウトのみ","店内のみ","宅配・配達代行のみ"],
    answer:"店内・テイクアウトのみ", category:"キャンペーン" },
  { prompt:"トッピング券を使うための条件は？",
    choices:["メイン注文（カレー／うどん／ラーメン／ドリア）","ドリンク注文","お子様カレーでもOK","トッピングだけでもOK"],
    answer:"メイン注文（カレー／うどん／ラーメン／ドリア）", category:"キャンペーン" },
  { prompt:"レジで「みせココA～D」を選ぶとき、Aに該当するのは？",
    choices:["ナス3個","クリームコロッケ","ほうれん草","フィッシュフライ"],
    answer:"ほうれん草", category:"レジ操作" },
  { prompt:"お客様への声かけで正しいのは？",
    choices:["今すぐ使えるクーポンです！","来月からお使いいただけるトッピング券が当たるくじです","金券としてお使いください","ドリンク専用です"],
    answer:"来月からお使いいただけるトッピング券が当たるくじです", category:"接客" },
  { prompt:"他クーポンとの併用は可能？",
    choices:["すべて併用できる","一切不可","金券は併用できるが、他クーポンは不可","トッピング券とトッピング券なら併用可"],
    answer:"金券は併用できるが、他クーポンは不可", category:"キャンペーン" },
  { prompt:"タブレットでレジ処理する場合、正しい手順は？",
    choices:["SLMキー → みせココ","期間限定トッピング → みせココ","メインメニュー → 期間限定トッピング","みせココ → 金券"],
    answer:"期間限定トッピング → みせココ", category:"レジ操作" }
];

// ====== 便利関数 & 効果音 ======
const norm = s => (s??"").trim().toLowerCase().normalize("NFKC");
const shuffle = arr => arr.sort(()=>Math.random()-0.5);
let audioCtx;
function ping(ok=true){
  audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type = ok ? "sine" : "square";
  if(ok){ o.frequency.setValueAtTime(880, audioCtx.currentTime);
          o.frequency.exponentialRampToValueAtTime(1320, audioCtx.currentTime+0.15); }
  else  { o.frequency.setValueAtTime(220, audioCtx.currentTime);
          o.frequency.setValueAtTime(180, audioCtx.currentTime+0.12); }
  g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.22, audioCtx.currentTime+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.25);
  o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.26);
}

// ====== 状態/UI要素 ======
let pool=[], idx=0, score=0, settings={count:5, category:null, shuffle:true};
const splash=document.getElementById('splash'), app=document.getElementById('app');
const startV=document.getElementById('start'), quizV=document.getElementById('quiz'), finV=document.getElementById('finish');
const catSel=document.getElementById('category'), qRange=document.getElementById('qcount'), qLabel=document.getElementById('qcountLabel'), shuf=document.getElementById('shuffle');
const promptEl=document.getElementById('prompt'), choiceBox=document.getElementById('choiceBox');
const inputBox=document.getElementById('inputBox'), ansInput=document.getElementById('answerInput'), ansBtn=document.getElementById('answerBtn');
const resultEl=document.getElementById('result'), nextBtn=document.getElementById('nextBtn'), bar=document.getElementById('bar'), catChip=document.getElementById('catChip'), scoreEl=document.getElementById('score');

// ====== 初期化 ======
setTimeout(()=>{ splash.style.display='none'; app.style.display='block'; }, 1000);
(function(){
  const cats = Array.from(new Set(QUESTIONS.map(q=>q.category))).sort();
  catSel.innerHTML = `<option value="">（すべて）</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  qRange.max = Math.max(QUESTIONS.length,3);
})();
qRange.addEventListener('input', ()=> qLabel.textContent = qRange.value);
document.getElementById('startBtn').onclick = ()=>{ settings.count=+qRange.value; settings.category=catSel.value||null; settings.shuffle=shuf.checked; start(); };
document.getElementById('againBtn').onclick = ()=>{ startV.style.display='block'; quizV.style.display='none'; finV.style.display='none'; };
ansBtn.onclick = ()=> checkInput(); nextBtn.onclick = ()=> next();

// ====== ロジック ======
function start(){
  pool = QUESTIONS.filter(q=>!settings.category||q.category===settings.category);
  shuffle(pool); pool = pool.slice(0, settings.count);
  idx=0; score=0; startV.style.display='none'; finV.style.display='none'; quizV.style.display='block'; render();
}
function render(){
  const q = pool[idx]; if(!q){ finish(); return; }
  bar.style.width = `${Math.round((idx)/Math.max(1,pool.length)*100)}%`;
  resultEl.style.display='none'; resultEl.textContent=''; nextBtn.disabled=true;
  catChip.textContent=q.category; promptEl.textContent=q.prompt; choiceBox.innerHTML=''; inputBox.style.display='none';
  if(q.choices && q.choices.length){
    let opts = q.choices.slice(); if(settings.shuffle) opts = shuffle(opts);
    opts.forEach(txt=>{
      const b=document.createElement('button'); b.className='opt'; b.textContent=txt;
      b.onclick=()=>{
        const ok = norm(txt)===norm(q.answer);
        if(ok){ score++; ping(true);} else { ping(false); }
        resultEl.textContent = ok ? "正解！🎉" : `残念… 正解は「${q.answer}」`; resultEl.style.display='block';
        [...choiceBox.children].forEach(c=>{
          const t=c.textContent;
          c.classList.add(norm(t)===norm(q.answer)?'correct':(t===txt?'incorrect':''));
          c.disabled=true;
        });
        nextBtn.disabled=false;
      };
      choiceBox.appendChild(b);
    });
  }else{
    inputBox.style.display='block'; ansInput.value=''; ansInput.focus();
  }
}
function checkInput(){
  const q=pool[idx]; const ok = norm(ansInput.value)===norm(q.answer);
  if(ok){ score++; ping(true);} else { ping(false); }
  resultEl.textContent = ok ? "正解！🎉" : `残念… 正解は「${q.answer}」`; resultEl.style.display='block'; nextBtn.disabled=false;
}
function next(){ idx++; if(idx>=pool.length){ finish(); } else { render(); } }
function finish(){ bar.style.width="100%"; quizV.style.display='none'; finV.style.display='block'; scoreEl.textContent=`スコア： ${score} / ${pool.length}`; }

// ====== Service Worker 登録 ======
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>
</body>
</html>
